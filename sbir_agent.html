<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBIR Grant Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .spinner {
            display: inline-block;
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #4f46e5; /* indigo-600 */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-center text-gray-700">SBIR Grant Management Dashboard</h1>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Column: Dashboard -->
            <div class="space-y-8">
                <!-- Budget Overview -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Budget Overview</h2>
                    <canvas id="budgetChart"></canvas>
                </section>

                <!-- Upcoming Deadlines -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Upcoming Deadlines</h2>
                    <ul id="deadlinesList" class="list-disc list-inside space-y-2">
                        <!-- Deadlines will be populated by JavaScript -->
                    </ul>
                </section>
            </div>

            <!-- Right Column: Reporting, Chatbot, and Documents -->
            <div class="space-y-8">
                <!-- Document Store -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Document Store</h2>
                    <form id="uploadForm" class="space-y-4">
                        <div>
                            <label for="fileInput" class="block text-sm font-medium text-gray-700">Select a file to upload:</label>
                            <input type="file" id="fileInput" name="file" class="mt-1 block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100"/>
                        </div>
                        <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded transition-all hover:shadow-lg transform hover:-translate-y-px">
                            Upload Document
                        </button>
                    </form>
                    <div id="uploadStatus" class="mt-4 text-sm"></div>
                    <hr class="my-6">
                    <h3 class="text-xl font-semibold mb-4">Uploaded Documents</h3>
                    <ul id="documentList" class="list-disc list-inside space-y-2">
                        <!-- Document list will be populated by JavaScript -->
                    </ul>
                </section>

                <!-- AI Reporting Assistant -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">AI Reporting Assistant</h2>
                        <div>
                            <select id="reportExpertSelect" class="p-1 border rounded-md text-sm"></select>
                            <span id="saveStatus" class="text-sm text-green-600 mx-4"></span>
                            <button id="saveReportBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded text-sm transition-all hover:shadow-md">
                                Save
                            </button>
                        </div>
                    </div>
                    <textarea id="reportInput" class="w-full h-40 p-2 border rounded-md" placeholder="Enter your accomplishments and data for the reporting period..."></textarea>
                    <button id="generateReportBtn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-all hover:shadow-lg transform hover:-translate-y-px">
                        Generate Report Draft
                    </button>
                    <div id="reportOutput" class="mt-4 p-4 bg-gray-50 rounded-md border hidden">
                        <!-- Generated report will appear here -->
                    </div>
                </section>

                <!-- Compliance Chatbot -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Compliance Chatbot</h2>
                        <select id="chatExpertSelect" class="p-1 border rounded-md text-sm"></select>
                    </div>
                    <div id="chatHistory" class="h-64 border rounded-md p-4 overflow-y-auto bg-gray-50 mb-4">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="flex">
                        <input type="text" id="chatInput" class="flex-grow p-2 border rounded-l-md" placeholder="Ask a question about SBIR rules...">
                        <button id="chatSendBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-r-md transition-all hover:shadow-lg transform hover:-translate-y-px">
                            Send
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // --- Global State and Configuration ---
        const DATA_API_ENDPOINT = '/api/data';
        const CHAT_API_ENDPOINT = '/api/chat';
        const UPLOAD_API_ENDPOINT = '/api/upload';
        const EXPERTS_API_ENDPOINT = '/api/experts';

        let appState = {
            budget: { spent: 0, remaining: 100000 },
            deadlines: [],
            reportText: "",
            chatHistory: [],
            documents: [],
            experts: []
        };

        // --- Core Functions ---

        async function loadExperts() {
            try {
                const response = await fetch(EXPERTS_API_ENDPOINT);
                if (!response.ok) throw new Error('Failed to load experts from server.');
                appState.experts = await response.json();
                console.log('LLM Experts loaded:', appState.experts);
            } catch (error) {
                console.error('Could not load LLM experts:', error);
                // Handle case where no experts are loaded, maybe show a warning.
            }
        }

        async function loadApplicationData() {
            try {
                const response = await fetch(DATA_API_ENDPOINT);
                if (!response.ok) throw new Error('Failed to load data from server.');
                const data = await response.json();
                data.documents = data.documents || [];
                appState = { ...appState, ...data }; // Merge loaded data with default state
                console.log('Application data loaded:', appState);
            } catch (error) {
                console.error('Could not load application data:', error);
            }
        }

        async function saveApplicationData() {
            const reportInput = document.getElementById('reportInput');
            appState.reportText = reportInput.value;

            try {
                const response = await fetch(DATA_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appState)
                });
                if (!response.ok) throw new Error('Failed to save data to server.');
                console.log('Application data saved.');

                const saveStatus = document.getElementById('saveStatus');
                saveStatus.textContent = 'Saved!';
                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 2000);

            } catch (error) {
                console.error('Could not save application data:', error);
                const saveStatus = document.getElementById('saveStatus');
                saveStatus.textContent = 'Save failed!';
                saveStatus.className = 'text-sm text-red-600 mr-4';
                setTimeout(() => {
                    saveStatus.textContent = '';
                    saveStatus.className = 'text-sm text-green-600 mr-4';
                }, 2000);
            }
        }

        // --- UI Setup Functions ---

        function populateExpertSelector(selectorId, experts) {
            const selector = document.getElementById(selectorId);
            selector.innerHTML = '';
            if (!experts || experts.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No experts configured';
                selector.appendChild(option);
                selector.disabled = true;
                return;
            }
            experts.forEach(expertName => {
                const option = document.createElement('option');
                option.value = expertName;
                option.textContent = expertName;
                selector.appendChild(option);
            });
        }

        function setupDashboard(budget, deadlines) {
            // ... (no changes) ...
        }

        function setupReportingAssistant(initialText, experts) {
            const generateReportBtn = document.getElementById('generateReportBtn');
            const reportInput = document.getElementById('reportInput');
            const reportOutput = document.getElementById('reportOutput');
            const saveReportBtn = document.getElementById('saveReportBtn');
            const expertSelect = document.getElementById('reportExpertSelect');

            populateExpertSelector('reportExpertSelect', experts);
            reportInput.value = initialText;
            saveReportBtn.addEventListener('click', saveApplicationData);

            generateReportBtn.addEventListener('click', async () => {
                const accomplishments = reportInput.value.trim();
                const selectedExpert = expertSelect.value;
                if (accomplishments === "") { /* ... */ return; }
                if (expertSelect.disabled) { /* ... */ return; }

                reportOutput.innerHTML = '<div class="spinner"></div>';
                reportOutput.classList.remove('hidden');

                const systemPrompt = `You are an AI assistant...`;
                const messages = [{ role: 'system', content: systemPrompt }, { role: 'user', content: accomplishments }];

                try {
                    const response = await fetch(CHAT_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: selectedExpert, messages: messages })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `API request failed`);
                    reportOutput.innerHTML = data.choices[0].message.content.replace(/```html/g, '').replace(/```/g, '');
                } catch (error) {
                    reportOutput.innerHTML = `<p class="text-red-500">Sorry, I encountered an error. Error: ${error.message}</p>`;
                }
            });
        }

        function setupChatbot(initialHistory, experts) {
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatInput = document.getElementById('chatInput');
            const chatHistoryEl = document.getElementById('chatHistory');
            const expertSelect = document.getElementById('chatExpertSelect');

            populateExpertSelector('chatExpertSelect', experts);
            appState.chatHistory = initialHistory || [];

            const displayMessage = (role, content) => {
                if (role === 'system') return;
                const messageDiv = document.createElement('div');
                messageDiv.className = `${role === 'user' ? 'text-right' : 'text-left'} mb-2`;
                messageDiv.innerHTML = `<span class="${role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-800'} p-2 rounded-lg inline-block">${content}</span>`;
                chatHistoryEl.appendChild(messageDiv);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            };

            // Re-render history from appState
            chatHistoryEl.innerHTML = '';
            appState.chatHistory.forEach(msg => displayMessage(msg.role, msg.content));

            const handleSendMessage = async () => {
                const userInput = chatInput.value.trim();
                const selectedExpert = expertSelect.value;
                if (userInput === "" || expertSelect.disabled) return;

                const userMessage = { role: 'user', content: userInput };
                displayMessage(userMessage.role, userMessage.content);
                appState.chatHistory.push(userMessage);
                chatInput.value = "";

                const thinkingDiv = document.createElement('div');
                thinkingDiv.id = 'thinking-indicator';
                thinkingDiv.className = 'text-left mb-2 flex justify-start';
                thinkingDiv.innerHTML = `<div class="spinner"></div>`;
                chatHistoryEl.appendChild(thinkingDiv);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

                // We send the entire history including the system prompt
                const conversationHistory = [
                    { role: 'system', content: 'You are an expert assistant for U.S. Small Business Innovation Research (SBIR) grants...' },
                    ...appState.chatHistory
                ];

                try {
                    const response = await fetch(CHAT_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: selectedExpert, messages: conversationHistory })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `API request failed`);

                    const botResponse = data.choices[0].message.content;
                    const assistantMessage = { role: 'assistant', content: botResponse };
                    displayMessage(assistantMessage.role, assistantMessage.content);
                    appState.chatHistory.push(assistantMessage);

                    await saveApplicationData();

                } catch (error) {
                    displayMessage('assistant', `Sorry, an error occurred: ${error.message}`);
                } finally {
                    thinkingDiv.remove();
                }
            };

            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') handleSendMessage();
            });
        }

        function setupDocumentStore(initialDocuments) {
            // ... (no changes) ...
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadExperts();
            await loadApplicationData();
            setupDashboard(appState.budget, appState.deadlines);
            setupReportingAssistant(appState.reportText, appState.experts);
            setupChatbot(appState.chatHistory, appState.experts);
            setupDocumentStore(appState.documents);
        });
    </script>

</body>
</html>
