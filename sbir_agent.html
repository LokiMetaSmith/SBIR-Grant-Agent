<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBIR Grant Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .spinner {
            display: inline-block;
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #4f46e5; /* indigo-600 */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-center text-gray-700">SBIR Grant Management Dashboard</h1>
        </header>

        <main class="space-y-8">
            <!-- Flagged Opportunities Section -->
            <section class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-purple-700">Flagged for You</h2>
                <div id="flaggedOpportunitiesList">
                    <!-- Flagged opportunities will be populated here -->
                </div>
            </section>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Left Column: Dashboard -->
                <div class="space-y-8">
                <!-- Budget Overview -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Budget Overview</h2>
                    <canvas id="budgetChart"></canvas>
                </section>

                <!-- Upcoming Deadlines -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Upcoming Deadlines</h2>
                    <ul id="deadlinesList" class="list-disc list-inside space-y-2">
                        <!-- Deadlines will be populated by JavaScript -->
                    </ul>
                </section>

                <!-- Opportunity Search -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Opportunity Search (sam.gov)</h2>
                    <form id="opportunitySearchForm" class="space-y-4">
                        <input type="text" id="searchKeywords" placeholder="Keywords (e.g., SBIR, AI, sensor)" class="w-full p-2 border rounded-md">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="searchPostedFrom" class="block text-sm font-medium text-gray-700">Posted From:</label>
                                <input type="date" id="searchPostedFrom" class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="searchPostedTo" class="block text-sm font-medium text-gray-700">Posted To:</label>
                                <input type="date" id="searchPostedTo" class="w-full p-2 border rounded-md">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded transition-all hover:shadow-lg transform hover:-translate-y-px">
                            Search for Opportunities
                        </button>
                    </form>
                    <div id="opportunityResults" class="mt-6">
                        <!-- Search results will be populated here -->
                    </div>
                </section>

                <!-- Research Profile -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Research Profile</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="capabilities" class="block text-sm font-medium text-gray-700">Core Capabilities</label>
                            <textarea id="capabilities" rows="4" class="w-full p-2 border rounded-md" placeholder="Enter your team's core technical capabilities, skills, and resources..."></textarea>
                        </div>
                        <div>
                            <label for="topics" class="block text-sm font-medium text-gray-700">Research Topics of Interest</label>
                            <textarea id="topics" rows="4" class="w-full p-2 border rounded-md" placeholder="Enter keywords, domains, and specific research topics of interest..."></textarea>
                        </div>
                        <button id="saveProfileBtn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded transition-all hover:shadow-lg transform hover:-translate-y-px">
                            Save Profile
                        </button>
                        <div id="profileSaveStatus" class="text-center text-sm text-green-600 h-4"></div>
                    </div>
                </section>
            </div>

            <!-- Right Column: Reporting, Chatbot, and Documents -->
            <div class="space-y-8">
                <!-- Document Store -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Document Store</h2>
                    <form id="uploadForm" class="space-y-4">
                        <div>
                            <label for="fileInput" class="block text-sm font-medium text-gray-700">Select a file to upload:</label>
                            <input type="file" id="fileInput" name="file" class="mt-1 block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100"/>
                        </div>
                        <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded transition-all hover:shadow-lg transform hover:-translate-y-px">
                            Upload Document
                        </button>
                    </form>
                    <div id="uploadStatus" class="mt-4 text-sm"></div>
                    <hr class="my-6">
                    <h3 class="text-xl font-semibold mb-4">Uploaded Documents</h3>
                    <ul id="documentList" class="list-disc list-inside space-y-2">
                        <!-- Document list will be populated by JavaScript -->
                    </ul>
                </section>

                <!-- AI Reporting Assistant -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">AI Reporting Assistant</h2>
                        <div>
                            <select id="reportExpertSelect" class="p-1 border rounded-md text-sm"></select>
                            <span id="saveStatus" class="text-sm text-green-600 mx-4"></span>
                            <button id="saveReportBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded text-sm transition-all hover:shadow-md">
                                Save
                            </button>
                        </div>
                    </div>
                    <textarea id="reportInput" class="w-full h-40 p-2 border rounded-md" placeholder="Enter your accomplishments and data for the reporting period..."></textarea>
                    <button id="generateReportBtn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-all hover:shadow-lg transform hover:-translate-y-px">
                        Generate Report Draft
                    </button>
                    <div id="reportOutput" class="mt-4 p-4 bg-gray-50 rounded-md border hidden">
                        <!-- Generated report will appear here -->
                    </div>
                </section>

                <!-- Compliance Chatbot -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Compliance Chatbot</h2>
                        <select id="chatExpertSelect" class="p-1 border rounded-md text-sm"></select>
                    </div>
                    <div id="chatHistory" class="h-64 border rounded-md p-4 overflow-y-auto bg-gray-50 mb-4">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="flex">
                        <input type="text" id="chatInput" class="flex-grow p-2 border rounded-l-md" placeholder="Ask a question about SBIR rules...">
                        <button id="chatSendBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-r-md transition-all hover:shadow-lg transform hover:-translate-y-px">
                            Send
                        </button>
                    </div>
                </section>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Application Draft -->
    <div id="draftModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-2xl leading-6 font-medium text-gray-900">Generated Application Draft</h3>
                <div id="draftModalContent" class="mt-4 px-7 py-3 max-h-96 overflow-y-auto text-left">
                    <!-- Draft content will be populated here -->
                </div>
                <div class="items-center px-4 py-3">
                    <button id="copyDraftBtn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Copy to Clipboard
                    </button>
                    <button id="closeModalBtn" class="ml-4 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State and Configuration ---
        const DATA_API_ENDPOINT = '/api/data';
        const CHAT_API_ENDPOINT = '/api/chat';
        const UPLOAD_API_ENDPOINT = '/api/upload';
        const EXPERTS_API_ENDPOINT = '/api/experts';

        let appState = {
            budget: { spent: 0, remaining: 100000 },
            deadlines: [],
            reportText: "",
            chatHistory: [],
            documents: [],
            experts: [],
            matchedOpportunities: []
        };

        // --- Core Functions ---

        async function loadExperts() {
            try {
                const response = await fetch(EXPERTS_API_ENDPOINT);
                if (!response.ok) throw new Error('Failed to load experts from server.');
                appState.experts = await response.json();
                console.log('LLM Experts loaded:', appState.experts);
            } catch (error) {
                console.error('Could not load LLM experts:', error);
            }
        }

        async function loadApplicationData() {
            try {
                const response = await fetch(DATA_API_ENDPOINT);
                if (!response.ok) throw new Error('Failed to load data from server.');
                const data = await response.json();
                appState = { ...appState, ...data };
                console.log('Application data loaded:', appState);
            } catch (error) {
                console.error('Could not load application data:', error);
            }
        }

        async function saveApplicationData(statusElementId = 'saveStatus') {
            appState.reportText = document.getElementById('reportInput').value;
            appState.researchProfile.capabilities = document.getElementById('capabilities').value;
            appState.researchProfile.topics = document.getElementById('topics').value;

            const statusEl = document.getElementById(statusElementId);

            try {
                const response = await fetch(DATA_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appState)
                });
                if (!response.ok) throw new Error('Failed to save data to server.');
                console.log('Application data saved.');

                statusEl.className = 'text-sm text-green-600';
                statusEl.textContent = 'Saved!';
                setTimeout(() => { statusEl.textContent = ''; }, 2000);

            } catch (error) {
                console.error('Could not save application data:', error);
                statusEl.className = 'text-sm text-red-600';
                statusEl.textContent = 'Save failed!';
                setTimeout(() => { statusEl.textContent = ''; }, 2000);
            }
        }

        // --- UI Setup Functions ---

        function populateExpertSelector(selectorId, experts) {
            const selector = document.getElementById(selectorId);
            selector.innerHTML = '';
            if (!experts || experts.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No experts configured';
                selector.appendChild(option);
                selector.disabled = true;
                return;
            }
            experts.forEach(expertName => {
                const option = document.createElement('option');
                option.value = expertName;
                option.textContent = expertName;
                selector.appendChild(option);
            });
        }

        function setupDashboard(budget, deadlines) {
            const budgetCtx = document.getElementById('budgetChart').getContext('2d');
            new Chart(budgetCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Spent', 'Remaining'],
                    datasets: [{
                        label: 'Budget',
                        data: [budget.spent, budget.remaining],
                        backgroundColor: ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)'],
                        borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: `Total Budget: $${budget.spent + budget.remaining}` } } }
            });

            const deadlinesList = document.getElementById('deadlinesList');
            deadlinesList.innerHTML = '';
            (deadlines || []).forEach(deadline => {
                const li = document.createElement('li');
                li.textContent = `${deadline.name} (Due: ${deadline.date})`;
                deadlinesList.appendChild(li);
            });
        }

        function setupReportingAssistant(initialText, experts) {
            const generateReportBtn = document.getElementById('generateReportBtn');
            const reportInput = document.getElementById('reportInput');
            const reportOutput = document.getElementById('reportOutput');
            const saveReportBtn = document.getElementById('saveReportBtn');
            const expertSelect = document.getElementById('reportExpertSelect');

            populateExpertSelector('reportExpertSelect', experts);
            reportInput.value = initialText || "";
            saveReportBtn.addEventListener('click', () => saveApplicationData('saveStatus'));

            generateReportBtn.addEventListener('click', async () => {
                const accomplishments = reportInput.value.trim();
                const selectedExpert = expertSelect.value;
                if (accomplishments === "" || expertSelect.disabled) {
                    reportOutput.innerHTML = `<p class="text-red-500">Please enter accomplishments and select an expert.</p>`;
                    reportOutput.classList.remove('hidden');
                    return;
                }

                reportOutput.innerHTML = '<div class="spinner mx-auto"></div>';
                reportOutput.classList.remove('hidden');

                const systemPrompt = `You are an AI assistant specialized in generating sections for U.S. Small Business Innovation Research (SBIR) grant reports. Your task is to take the user's raw notes and accomplishments and format them into a professional, well-structured report section. The tone should be formal and objective. Focus on clearly presenting the technical progress and outcomes.`;
                const messages = [{ role: 'system', content: systemPrompt }, { role: 'user', content: accomplishments }];

                try {
                    const response = await fetch(CHAT_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: selectedExpert, messages: messages })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `API request failed`);
                    reportOutput.innerHTML = data.choices[0].message.content.replace(/```html/g, '').replace(/```/g, '');
                } catch (error) {
                    reportOutput.innerHTML = `<p class="text-red-500">Sorry, I encountered an error. Error: ${error.message}</p>`;
                }
            });
        }

        function setupChatbot(initialHistory, experts) {
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatInput = document.getElementById('chatInput');
            const chatHistoryEl = document.getElementById('chatHistory');
            const expertSelect = document.getElementById('chatExpertSelect');

            populateExpertSelector('chatExpertSelect', experts);
            appState.chatHistory = initialHistory || [];

            const displayMessage = (role, content) => {
                if (role === 'system') return;
                const messageDiv = document.createElement('div');
                messageDiv.className = `${role === 'user' ? 'text-right' : 'text-left'} mb-2`;
                messageDiv.innerHTML = `<span class="${role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-800'} p-2 rounded-lg inline-block">${content}</span>`;
                chatHistoryEl.appendChild(messageDiv);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            };

            chatHistoryEl.innerHTML = '';
            appState.chatHistory.forEach(msg => displayMessage(msg.role, msg.content));

            const handleSendMessage = async () => {
                const userInput = chatInput.value.trim();
                const selectedExpert = expertSelect.value;
                if (userInput === "" || expertSelect.disabled) return;

                const userMessage = { role: 'user', content: userInput };
                displayMessage(userMessage.role, userMessage.content);
                appState.chatHistory.push(userMessage);
                chatInput.value = "";

                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'text-left mb-2 flex justify-start';
                thinkingDiv.innerHTML = `<div class="spinner mx-auto"></div>`;
                chatHistoryEl.appendChild(thinkingDiv);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

                const conversationHistory = [
                    { role: 'system', content: 'You are an expert assistant for U.S. Small Business Innovation Research (SBIR) grants...' },
                    ...appState.chatHistory
                ];

                try {
                    const response = await fetch(CHAT_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: selectedExpert, messages: conversationHistory })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `API request failed`);

                    const botResponse = data.choices[0].message.content;
                    const assistantMessage = { role: 'assistant', content: botResponse };
                    displayMessage(assistantMessage.role, assistantMessage.content);
                    appState.chatHistory.push(assistantMessage);

                    await saveApplicationData('saveStatus');

                } catch (error) {
                    displayMessage('assistant', `Sorry, an error occurred: ${error.message}`);
                } finally {
                    thinkingDiv.remove();
                }
            };

            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') handleSendMessage();
            });
        }

        function setupDocumentStore(initialDocuments) {
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('fileInput');
            const uploadStatus = document.getElementById('uploadStatus');
            const documentList = document.getElementById('documentList');

            appState.documents = initialDocuments || [];

            const renderDocuments = () => {
                documentList.innerHTML = '';
                if (!appState.documents || appState.documents.length === 0) {
                    documentList.innerHTML = '<li>No documents uploaded yet.</li>';
                    return;
                }
                appState.documents.forEach(doc => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = doc.path;
                    a.textContent = doc.filename;
                    a.target = '_blank';
                    a.className = 'text-indigo-600 hover:text-indigo-800 underline';
                    li.appendChild(a);
                    documentList.appendChild(li);
                });
            };

            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = fileInput.files[0];
                if (!file) {
                    uploadStatus.textContent = 'Please select a file first.';
                    uploadStatus.className = 'mt-4 text-sm text-red-600';
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                uploadStatus.innerHTML = '<div class="spinner mx-auto"></div>';
                uploadStatus.className = 'mt-4 flex justify-center';

                try {
                    const response = await fetch(UPLOAD_API_ENDPOINT, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'File upload failed.');

                    uploadStatus.textContent = `Successfully uploaded "${result.filename}"!`;
                    uploadStatus.className = 'mt-4 text-sm text-green-600';

                    appState.documents.push({ filename: result.filename, path: result.path });
                    await saveApplicationData();

                    renderDocuments();
                    uploadForm.reset();

                } catch (error) {
                    uploadStatus.textContent = `Upload failed: ${error.message}`;
                    uploadStatus.className = 'mt-4 text-sm text-red-600';
                }
            });

            renderDocuments();
        }

        function setupResearchProfile(profile) {
            const capabilitiesInput = document.getElementById('capabilities');
            const topicsInput = document.getElementById('topics');
            const saveBtn = document.getElementById('saveProfileBtn');

            if (profile) {
                capabilitiesInput.value = profile.capabilities || '';
                topicsInput.value = profile.topics || '';
            }

            saveBtn.addEventListener('click', () => saveApplicationData('profileSaveStatus'));
        }

        function setupOpportunitySearch() {
            const searchForm = document.getElementById('opportunitySearchForm');
            const keywordsInput = document.getElementById('searchKeywords');
            const postedFromInput = document.getElementById('searchPostedFrom');
            const postedToInput = document.getElementById('searchPostedTo');
            const resultsDiv = document.getElementById('opportunityResults');
            let currentOpportunities = [];

            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const postedFrom = postedFromInput.value;
                const postedTo = postedToInput.value;

                if (!postedFrom || !postedTo) {
                    resultsDiv.innerHTML = `<p class="text-red-500">Please select both a "From" and "To" date.</p>`;
                    return;
                }

                resultsDiv.innerHTML = '<div class="spinner mx-auto"></div>';
                const formattedPostedFrom = new Date(postedFrom).toLocaleDateString('en-US');
                const formattedPostedTo = new Date(postedTo).toLocaleDateString('en-US');

                try {
                    const response = await fetch('/api/search_opportunities', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            keywords: keywordsInput.value,
                            postedFrom: formattedPostedFrom,
                            postedTo: formattedPostedTo
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Failed to fetch opportunities.');

                    currentOpportunities = data;
                    resultsDiv.innerHTML = '';
                    if (data.length === 0) {
                        resultsDiv.innerHTML = '<p>No opportunities found for the selected criteria.</p>';
                        return;
                    }

                    const ul = document.createElement('ul');
                    ul.className = 'space-y-4';
                    data.forEach((opp, index) => {
                        const li = document.createElement('li');
                        li.className = 'p-4 border rounded-md bg-gray-50';
                        li.innerHTML = `
                            <h4 class="font-bold text-lg">${opp.title}</h4>
                            <p class="text-sm text-gray-600">${opp.fullParentPathName || 'N/A'}</p>
                            <p class="text-sm"><strong>Solicitation #:</strong> ${opp.solicitationNumber || 'N/A'}</p>
                            <p class="text-sm"><strong>Posted:</strong> ${opp.postedDate}</p>
                            <div class="mt-2">
                                ${opp.uiLink ? `<a href="${opp.uiLink}" target="_blank" class="text-indigo-600 hover:underline">View on sam.gov</a>` : ''}
                                <button data-index="${index}" class="draft-btn ml-4 px-3 py-1 bg-cyan-500 text-white text-xs font-bold rounded-full hover:bg-cyan-600">Draft Application</button>
                            </div>
                        `;
                        ul.appendChild(li);
                    });
                    resultsDiv.appendChild(ul);

                } catch (error) {
                    resultsDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                }
            });

            resultsDiv.addEventListener('click', async (e) => {
                if (e.target.classList.contains('draft-btn')) {
                    const index = e.target.dataset.index;
                    const opportunity = currentOpportunities[index];
                    const expertSelect = document.getElementById('chatExpertSelect');
                    const selectedExpert = expertSelect.value;

                    if (expertSelect.disabled) {
                        alert("Please configure an LLM expert first.");
                        return;
                    }

                    openDraftModal(opportunity, selectedExpert);
                }
            });
        }

        function setupDraftModal() {
            const modal = document.getElementById('draftModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const copyDraftBtn = document.getElementById('copyDraftBtn');
            const modalContent = document.getElementById('draftModalContent');

            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            copyDraftBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(modalContent.innerText);
                copyDraftBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyDraftBtn.textContent = 'Copy to Clipboard';
                }, 2000);
            });
        }

        async function openDraftModal(opportunity, selectedExpert) {
            const modal = document.getElementById('draftModal');
            const modalContent = document.getElementById('draftModalContent');

            modal.classList.remove('hidden');
            modalContent.innerHTML = '<div class="spinner mx-auto"></div>';

            try {
                const response = await fetch('/api/draft_application', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        opportunity: opportunity,
                        profile: appState.researchProfile,
                        expert: selectedExpert
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to generate draft.');

                modalContent.innerHTML = `<pre class="whitespace-pre-wrap font-sans text-sm">${data.draft}</pre>`;

            } catch (error) {
                modalContent.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }

        function setupFlaggedOpportunities(opportunities) {
            const listDiv = document.getElementById('flaggedOpportunitiesList');
            listDiv.innerHTML = '';
            if (!opportunities || opportunities.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500">No new opportunities flagged by the agent yet. The agent runs once a day.</p>';
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'space-y-4';
            opportunities.forEach((match, index) => {
                const opp = match.opportunity;
                const li = document.createElement('li');
                li.className = 'p-4 border rounded-md bg-purple-50';
                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg">${opp.title}</h4>
                            <p class="text-sm text-gray-600">${opp.fullParentPathName || 'N/A'}</p>
                        </div>
                        <button data-index="${index}" class="draft-btn-flagged px-3 py-1 bg-cyan-500 text-white text-xs font-bold rounded-full hover:bg-cyan-600">Draft Application</button>
                    </div>
                    <p class="mt-2 text-sm italic text-purple-800"><strong>Justification:</strong> ${match.match_analysis.justification}</p>
                    <a href="${opp.uiLink}" target="_blank" class="text-sm text-indigo-600 hover:underline">View on sam.gov</a>
                `;
                ul.appendChild(li);
            });
            listDiv.appendChild(ul);

            listDiv.addEventListener('click', async (e) => {
                if (e.target.classList.contains('draft-btn-flagged')) {
                    const index = e.target.dataset.index;
                    const opportunity = opportunities[index].opportunity;
                    const expertSelect = document.getElementById('chatExpertSelect');
                    const selectedExpert = expertSelect.value;
                    if (expertSelect.disabled) {
                        alert("Please configure an LLM expert first.");
                        return;
                    }
                    openDraftModal(opportunity, selectedExpert);
                }
            });
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadExperts();
            await loadApplicationData();
            setupDashboard(appState.budget, appState.deadlines);
            setupReportingAssistant(appState.reportText, appState.experts);
            setupChatbot(appState.chatHistory, appState.experts);
            setupDocumentStore(appState.documents);
            setupOpportunitySearch();
            setupResearchProfile(appState.researchProfile);
            setupDraftModal();
            setupFlaggedOpportunities(appState.matchedOpportunities);
        });
    </script>

</body>
</html>