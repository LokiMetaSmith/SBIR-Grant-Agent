<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBIR Grant Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-center text-gray-700">SBIR Grant Management Dashboard</h1>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Column: Dashboard -->
            <div class="space-y-8">
                <!-- Budget Overview -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Budget Overview</h2>
                    <canvas id="budgetChart"></canvas>
                </section>

                <!-- Upcoming Deadlines -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Upcoming Deadlines</h2>
                    <ul id="deadlinesList" class="list-disc list-inside space-y-2">
                        <!-- Deadlines will be populated by JavaScript -->
                    </ul>
                </section>
            </div>

            <!-- Right Column: Reporting and Chatbot -->
            <div class="space-y-8">
                <!-- AI Reporting Assistant -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">AI Reporting Assistant</h2>
                    <textarea id="reportInput" class="w-full h-40 p-2 border rounded-md" placeholder="Enter your accomplishments and data for the reporting period..."></textarea>
                    <button id="generateReportBtn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        Generate Report Draft
                    </button>
                    <div id="reportOutput" class="mt-4 p-4 bg-gray-50 rounded-md border hidden">
                        <!-- Generated report will appear here -->
                    </div>
                </section>

                <!-- Compliance Chatbot -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Compliance Chatbot</h2>
                    <div id="chatHistory" class="h-64 border rounded-md p-4 overflow-y-auto bg-gray-50 mb-4">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="flex">
                        <input type="text" id="chatInput" class="flex-grow p-2 border rounded-l-md" placeholder="Ask a question about SBIR rules...">
                        <button id="chatSendBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-r-md">
                            Send
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // --- Backend and LLM Configuration ---
        // The frontend now communicates with the local Python server, which securely handles the LLM API calls.
        const APP_API_ENDPOINT = '/api/chat';
        // Note: The specific LLM model is now passed in the body of the request.
        const CHATBOT_LLM_MODEL = 'llama3'; // Or any other model your backend is configured to use.
        const REPORTING_LLM_MODEL = 'llama3'; // You can use a different model for reporting if desired.

        // --- Dashboard Functionality ---
        function setupDashboard() {
            // 1. Implement Chart.js for budget overview
            const budgetCtx = document.getElementById('budgetChart').getContext('2d');
            new Chart(budgetCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Spent', 'Remaining'],
                    datasets: [{
                        label: 'Budget',
                        data: [75000, 25000], // Sample data: $75k spent, $25k remaining
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Total Budget: $100,000'
                        }
                    }
                }
            });

            // 2. Populate upcoming deadlines
            const deadlinesList = document.getElementById('deadlinesList');
            const deadlines = [
                { name: 'Quarterly Report - Q3', date: '2024-09-30' },
                { name: 'Final Project Report', date: '2024-12-31' },
                { name: 'Invention Disclosure Report', date: '2025-01-15' }
            ];

            deadlines.forEach(deadline => {
                const li = document.createElement('li');
                li.textContent = `${deadline.name} (Due: ${deadline.date})`;
                deadlinesList.appendChild(li);
            });
        }

        // --- Reporting Assistant Functionality (LLM-Powered via Backend) ---
        function setupReportingAssistant() {
            const generateReportBtn = document.getElementById('generateReportBtn');
            const reportInput = document.getElementById('reportInput');
            const reportOutput = document.getElementById('reportOutput');

            generateReportBtn.addEventListener('click', async () => {
                const accomplishments = reportInput.value.trim();

                if (accomplishments === "") {
                    reportOutput.innerHTML = `<p class="text-red-500">Please enter your accomplishments before generating a report.</p>`;
                    reportOutput.classList.remove('hidden');
                    return;
                }

                // Show loading state
                reportOutput.innerHTML = `<p class="text-gray-500">Generating draft...</p>`;
                reportOutput.classList.remove('hidden');

                const systemPrompt = `You are an AI assistant specialized in generating sections for U.S. Small Business Innovation Research (SBIR) grant reports. Your task is to take the user's raw notes and accomplishments and format them into a professional, well-structured report section. The tone should be formal and objective. Focus on clearly presenting the technical progress and outcomes.`;

                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: accomplishments }
                ];

                try {
                    const response = await fetch(APP_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: REPORTING_LLM_MODEL,
                            messages: messages
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || `API request failed with status ${response.status}`);
                    }

                    const reportDraft = data.choices[0].message.content;

                    // Sanitize the output slightly to avoid LLMs adding markdown to the whole block
                    const formattedReport = reportDraft.replace(/```html/g, '').replace(/```/g, '');
                    reportOutput.innerHTML = formattedReport;

                } catch (error) {
                    console.error("Error calling backend for reporting:", error);
                    reportOutput.innerHTML = `<p class="text-red-500">Sorry, I encountered an error while generating the report. Error: ${error.message}</p>`;
                }
            });
        }

        // --- Compliance Chatbot Functionality (LLM-Powered via Backend) ---
        function setupChatbot() {
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatInput = document.getElementById('chatInput');
            const chatHistory = document.getElementById('chatHistory');

            const conversationHistory = [{
                role: 'system',
                content: 'You are an expert assistant for U.S. Small Business Innovation Research (SBIR) grants. Your goal is to provide accurate, helpful, and concise information about SBIR program rules, compliance, reporting, and management. Answer questions directly related to these topics. If a question is outside this scope, politely state that you can only answer questions about SBIR grants.'
            }];

            const displayMessage = (role, content) => {
                const messageDiv = document.createElement('div');
                const messageClass = role === 'user' ? 'text-right' : 'text-left';
                const bubbleClass = role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-800';
                messageDiv.className = `${messageClass} mb-2`;
                messageDiv.innerHTML = `<span class="${bubbleClass} p-2 rounded-lg inline-block">${content}</span>`;
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            };

            const handleSendMessage = async () => {
                const userInput = chatInput.value.trim();
                if (userInput === "") return;

                displayMessage('user', userInput);
                conversationHistory.push({ role: 'user', content: userInput });
                chatInput.value = "";

                // Show thinking indicator
                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'text-left mb-2';
                thinkingDiv.id = 'thinking-indicator';
                thinkingDiv.innerHTML = `<span class="bg-gray-300 text-gray-800 p-2 rounded-lg inline-block">...</span>`;
                chatHistory.appendChild(thinkingDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                try {
                    const response = await fetch(APP_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: CHATBOT_LLM_MODEL,
                            messages: conversationHistory
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || `API request failed with status ${response.status}`);
                    }

                    const botResponse = data.choices[0].message.content;

                    conversationHistory.push({ role: 'assistant', content: botResponse });
                    displayMessage('assistant', botResponse);

                } catch (error) {
                    console.error("Error calling backend:", error);
                    displayMessage('assistant', `Sorry, I encountered an error. Error: ${error.message}`);
                } finally {
                    // Remove thinking indicator
                    const indicator = document.getElementById('thinking-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            };

            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    handleSendMessage();
                }
            });
        }

        // Initialize all features when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            setupDashboard();
            setupReportingAssistant();
            setupChatbot();
        });
    </script>

</body>
</html>
