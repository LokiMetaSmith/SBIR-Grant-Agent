<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBIR Grant Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-center text-gray-700">SBIR Grant Management Dashboard</h1>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Column: Dashboard -->
            <div class="space-y-8">
                <!-- Budget Overview -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Budget Overview</h2>
                    <canvas id="budgetChart"></canvas>
                </section>

                <!-- Upcoming Deadlines -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Upcoming Deadlines</h2>
                    <ul id="deadlinesList" class="list-disc list-inside space-y-2">
                        <!-- Deadlines will be populated by JavaScript -->
                    </ul>
                </section>
            </div>

            <!-- Right Column: Reporting, Chatbot, and Documents -->
            <div class="space-y-8">
                <!-- Document Store -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Document Store</h2>
                    <form id="uploadForm" class="space-y-4">
                        <div>
                            <label for="fileInput" class="block text-sm font-medium text-gray-700">Select a file to upload:</label>
                            <input type="file" id="fileInput" name="file" class="mt-1 block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100"/>
                        </div>
                        <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">
                            Upload Document
                        </button>
                    </form>
                    <div id="uploadStatus" class="mt-4 text-sm"></div>
                    <hr class="my-6">
                    <h3 class="text-xl font-semibold mb-4">Uploaded Documents</h3>
                    <ul id="documentList" class="list-disc list-inside space-y-2">
                        <!-- Document list will be populated by JavaScript -->
                    </ul>
                </section>

                <!-- AI Reporting Assistant -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">AI Reporting Assistant</h2>
                        <button id="saveReportBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded text-sm">
                            Save
                        </button>
                    </div>
                    <textarea id="reportInput" class="w-full h-40 p-2 border rounded-md" placeholder="Enter your accomplishments and data for the reporting period..."></textarea>
                    <button id="generateReportBtn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        Generate Report Draft
                    </button>
                    <div id="reportOutput" class="mt-4 p-4 bg-gray-50 rounded-md border hidden">
                        <!-- Generated report will appear here -->
                    </div>
                </section>

                <!-- Compliance Chatbot -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Compliance Chatbot</h2>
                    <div id="chatHistory" class="h-64 border rounded-md p-4 overflow-y-auto bg-gray-50 mb-4">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="flex">
                        <input type="text" id="chatInput" class="flex-grow p-2 border rounded-l-md" placeholder="Ask a question about SBIR rules...">
                        <button id="chatSendBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-r-md">
                            Send
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // --- Global State and Configuration ---
        const DATA_API_ENDPOINT = '/api/data';
        const CHAT_API_ENDPOINT = '/api/chat';
        const UPLOAD_API_ENDPOINT = '/api/upload';
        const CHATBOT_LLM_MODEL = 'llama3';
        const REPORTING_LLM_MODEL = 'llama3';

        let appState = {
            budget: { spent: 0, remaining: 100000 },
            deadlines: [],
            reportText: "",
            chatHistory: [],
            documents: []
        };

        // --- Core Functions ---

        async function loadApplicationData() {
            try {
                const response = await fetch(DATA_API_ENDPOINT);
                if (!response.ok) throw new Error('Failed to load data from server.');
                const data = await response.json();
                // Ensure documents is always an array for backward compatibility
                data.documents = data.documents || [];
                appState = data;
                console.log('Application data loaded:', appState);
            } catch (error) {
                console.error('Could not load application data:', error);
                // On failure, the default appState will be used.
            }
        }

        async function saveApplicationData() {
            // Update appState with the latest from the UI before saving
            const reportInput = document.getElementById('reportInput');
            appState.reportText = reportInput.value;
            // Chat history and documents are updated directly in their respective functions.
            // Budget and deadlines are not yet editable.

            try {
                const response = await fetch(DATA_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appState)
                });
                if (!response.ok) throw new Error('Failed to save data to server.');
                console.log('Application data saved.');
            } catch (error) {
                console.error('Could not save application data:', error);
            }
        }

        // --- UI Setup Functions ---

        function setupDashboard(budget, deadlines) {
            const budgetCtx = document.getElementById('budgetChart').getContext('2d');
            new Chart(budgetCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Spent', 'Remaining'],
                    datasets: [{
                        label: 'Budget',
                        data: [budget.spent, budget.remaining],
                        backgroundColor: ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)'],
                        borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: `Total Budget: $${budget.spent + budget.remaining}` }
                    }
                }
            });

            const deadlinesList = document.getElementById('deadlinesList');
            deadlinesList.innerHTML = ''; // Clear existing
            deadlines.forEach(deadline => {
                const li = document.createElement('li');
                li.textContent = `${deadline.name} (Due: ${deadline.date})`;
                deadlinesList.appendChild(li);
            });
        }

        function setupReportingAssistant(initialText) {
            const generateReportBtn = document.getElementById('generateReportBtn');
            const reportInput = document.getElementById('reportInput');
            const reportOutput = document.getElementById('reportOutput');
            const saveReportBtn = document.getElementById('saveReportBtn');

            reportInput.value = initialText;
            saveReportBtn.addEventListener('click', saveApplicationData);

            generateReportBtn.addEventListener('click', async () => {
                const accomplishments = reportInput.value.trim();
                if (accomplishments === "") {
                    reportOutput.innerHTML = `<p class="text-red-500">Please enter your accomplishments.</p>`;
                    reportOutput.classList.remove('hidden');
                    return;
                }
                reportOutput.innerHTML = `<p class="text-gray-500">Generating draft...</p>`;
                reportOutput.classList.remove('hidden');

                const systemPrompt = `You are an AI assistant specialized in generating sections for U.S. Small Business Innovation Research (SBIR) grant reports. Your task is to take the user's raw notes and accomplishments and format them into a professional, well-structured report section. The tone should be formal and objective. Focus on clearly presenting the technical progress and outcomes.`;
                const messages = [{ role: 'system', content: systemPrompt }, { role: 'user', content: accomplishments }];

                try {
                    const response = await fetch(CHAT_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: REPORTING_LLM_MODEL, messages: messages })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `API request failed`);
                    reportOutput.innerHTML = data.choices[0].message.content.replace(/```html/g, '').replace(/```/g, '');
                } catch (error) {
                    reportOutput.innerHTML = `<p class="text-red-500">Sorry, I encountered an error. Error: ${error.message}</p>`;
                }
            });
        }

        function setupChatbot(initialHistory) {
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatInput = document.getElementById('chatInput');
            const chatHistoryEl = document.getElementById('chatHistory');

            appState.chatHistory = initialHistory || [];
            const conversationHistory = [ ...appState.chatHistory ];
            if (conversationHistory.length === 0 || conversationHistory[0].role !== 'system') {
                conversationHistory.unshift({
                    role: 'system',
                    content: 'You are an expert assistant for U.S. Small Business Innovation Research (SBIR) grants. Your goal is to provide accurate, helpful, and concise information about SBIR program rules, compliance, reporting, and management. Answer questions directly related to these topics. If a question is outside this scope, politely state that you can only answer questions about SBIR grants.'
                });
            }

            const displayMessage = (role, content) => {
                if (role === 'system') return;
                const messageDiv = document.createElement('div');
                messageDiv.className = `${role === 'user' ? 'text-right' : 'text-left'} mb-2`;
                messageDiv.innerHTML = `<span class="${role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-800'} p-2 rounded-lg inline-block">${content}</span>`;
                chatHistoryEl.appendChild(messageDiv);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            };

            conversationHistory.forEach(msg => displayMessage(msg.role, msg.content));

            const handleSendMessage = async () => {
                const userInput = chatInput.value.trim();
                if (userInput === "") return;

                const userMessage = { role: 'user', content: userInput };
                displayMessage(userMessage.role, userMessage.content);
                conversationHistory.push(userMessage);
                appState.chatHistory.push(userMessage);
                chatInput.value = "";

                const thinkingDiv = document.createElement('div');
                thinkingDiv.id = 'thinking-indicator';
                thinkingDiv.className = 'text-left mb-2';
                thinkingDiv.innerHTML = `<span class="bg-gray-300 text-gray-800 p-2 rounded-lg inline-block">...</span>`;
                chatHistoryEl.appendChild(thinkingDiv);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

                try {
                    const response = await fetch(CHAT_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: CHATBOT_LLM_MODEL, messages: conversationHistory })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `API request failed`);

                    const botResponse = data.choices[0].message.content;
                    const assistantMessage = { role: 'assistant', content: botResponse };
                    displayMessage(assistantMessage.role, assistantMessage.content);
                    conversationHistory.push(assistantMessage);
                    appState.chatHistory.push(assistantMessage);

                    await saveApplicationData();

                } catch (error) {
                    displayMessage('assistant', `Sorry, an error occurred: ${error.message}`);
                } finally {
                    thinkingDiv.remove();
                }
            };

            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') handleSendMessage();
            });
        }

        function setupDocumentStore(initialDocuments) {
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('fileInput');
            const uploadStatus = document.getElementById('uploadStatus');
            const documentList = document.getElementById('documentList');

            appState.documents = initialDocuments || [];

            const renderDocuments = () => {
                documentList.innerHTML = '';
                if (!appState.documents || appState.documents.length === 0) {
                    documentList.innerHTML = '<li>No documents uploaded yet.</li>';
                    return;
                }
                appState.documents.forEach(doc => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = doc.path;
                    a.textContent = doc.filename;
                    a.target = '_blank';
                    a.className = 'text-indigo-600 hover:text-indigo-800 underline';
                    li.appendChild(a);
                    documentList.appendChild(li);
                });
            };

            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = fileInput.files[0];
                if (!file) {
                    uploadStatus.textContent = 'Please select a file first.';
                    uploadStatus.className = 'mt-4 text-sm text-red-600';
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                uploadStatus.textContent = 'Uploading...';
                uploadStatus.className = 'mt-4 text-sm text-gray-600';

                try {
                    const response = await fetch(UPLOAD_API_ENDPOINT, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'File upload failed.');

                    uploadStatus.textContent = `Successfully uploaded "${result.filename}"!`;
                    uploadStatus.className = 'mt-4 text-sm text-green-600';

                    appState.documents.push({ filename: result.filename, path: result.path });
                    await saveApplicationData();

                    renderDocuments();
                    uploadForm.reset();

                } catch (error) {
                    uploadStatus.textContent = `Upload failed: ${error.message}`;
                    uploadStatus.className = 'mt-4 text-sm text-red-600';
                }
            });

            renderDocuments();
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadApplicationData();
            setupDashboard(appState.budget, appState.deadlines);
            setupReportingAssistant(appState.reportText);
            setupChatbot(appState.chatHistory);
            setupDocumentStore(appState.documents);
        });
    </script>

</body>
</html>
