<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBIR Grant Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-center text-gray-700">SBIR Grant Management Dashboard</h1>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Column: Dashboard -->
            <div class="space-y-8">
                <!-- Budget Overview -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Budget Overview</h2>
                    <canvas id="budgetChart"></canvas>
                </section>

                <!-- Upcoming Deadlines -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Upcoming Deadlines</h2>
                    <ul id="deadlinesList" class="list-disc list-inside space-y-2">
                        <!-- Deadlines will be populated by JavaScript -->
                    </ul>
                </section>
            </div>

            <!-- Right Column: Reporting and Chatbot -->
            <div class="space-y-8">
                <!-- AI Reporting Assistant -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">AI Reporting Assistant</h2>
                    <textarea id="reportInput" class="w-full h-40 p-2 border rounded-md" placeholder="Enter your accomplishments and data for the reporting period..."></textarea>
                    <button id="generateReportBtn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        Generate Report Draft
                    </button>
                    <div id="reportOutput" class="mt-4 p-4 bg-gray-50 rounded-md border hidden">
                        <!-- Generated report will appear here -->
                    </div>
                </section>

                <!-- Compliance Chatbot -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Compliance Chatbot</h2>
                    <div id="chatHistory" class="h-64 border rounded-md p-4 overflow-y-auto bg-gray-50 mb-4">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="flex">
                        <input type="text" id="chatInput" class="flex-grow p-2 border rounded-l-md" placeholder="Ask a question about SBIR rules...">
                        <button id="chatSendBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-r-md">
                            Send
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // --- LLM Chatbot Configuration ---
        // IMPORTANT: Replace these values with your LLM API details.
        // For local models (e.g., Ollama, LM Studio), you might not need an API key.
        // WARNING: Do not expose your API key in client-side code in a production environment.
        // This method is for prototyping and local use only.
        const LLM_API_ENDPOINT = 'http://localhost:11434/v1/chat/completions'; // Example for Ollama
        const LLM_API_KEY = 'ollama'; // Example for Ollama, can be any string
        const LLM_MODEL = 'llama3'; // Example for Ollama

        // --- Dashboard Functionality ---
        function setupDashboard() {
            // 1. Implement Chart.js for budget overview
            const budgetCtx = document.getElementById('budgetChart').getContext('2d');
            new Chart(budgetCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Spent', 'Remaining'],
                    datasets: [{
                        label: 'Budget',
                        data: [75000, 25000], // Sample data: $75k spent, $25k remaining
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Total Budget: $100,000'
                        }
                    }
                }
            });

            // 2. Populate upcoming deadlines
            const deadlinesList = document.getElementById('deadlinesList');
            const deadlines = [
                { name: 'Quarterly Report - Q3', date: '2024-09-30' },
                { name: 'Final Project Report', date: '2024-12-31' },
                { name: 'Invention Disclosure Report', date: '2025-01-15' }
            ];

            deadlines.forEach(deadline => {
                const li = document.createElement('li');
                li.textContent = `${deadline.name} (Due: ${deadline.date})`;
                deadlinesList.appendChild(li);
            });
        }

        // --- Reporting Assistant Functionality ---
        function setupReportingAssistant() {
            const generateReportBtn = document.getElementById('generateReportBtn');
            const reportInput = document.getElementById('reportInput');
            const reportOutput = document.getElementById('reportOutput');

            generateReportBtn.addEventListener('click', () => {
                const accomplishments = reportInput.value.trim();

                if (accomplishments === "") {
                    reportOutput.innerHTML = `<p class="text-red-500">Please enter your accomplishments before generating a report.</p>`;
                    reportOutput.classList.remove('hidden');
                    return;
                }

                // Simulate AI-generated report
                const reportDraft = `
                    <h3 class="text-xl font-semibold mb-2">Quarterly Report Draft</h3>
                    <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    <p><strong>Prepared For:</strong> SBIR Program Office</p>
                    <hr class="my-2">
                    <p><strong>Summary of Accomplishments:</p>
                    <p class="mt-2 pl-4 border-l-4 border-gray-300">${accomplishments}</p>
                    <p class="mt-4 text-sm text-gray-600"><em>This is a simulated AI-generated draft. Please review and edit as needed before submission.</em></p>
                `;

                reportOutput.innerHTML = reportDraft;
                reportOutput.classList.remove('hidden');
            });
        }

        // --- Compliance Chatbot Functionality (LLM-Powered) ---
        function setupChatbot() {
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatInput = document.getElementById('chatInput');
            const chatHistory = document.getElementById('chatHistory');

            const conversationHistory = [{
                role: 'system',
                content: 'You are an expert assistant for U.S. Small Business Innovation Research (SBIR) grants. Your goal is to provide accurate, helpful, and concise information about SBIR program rules, compliance, reporting, and management. Answer questions directly related to these topics. If a question is outside this scope, politely state that you can only answer questions about SBIR grants.'
            }];

            const displayMessage = (role, content) => {
                const messageDiv = document.createElement('div');
                const messageClass = role === 'user' ? 'text-right' : 'text-left';
                const bubbleClass = role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-800';
                messageDiv.className = `${messageClass} mb-2`;
                messageDiv.innerHTML = `<span class="${bubbleClass} p-2 rounded-lg inline-block">${content}</span>`;
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            };

            const handleSendMessage = async () => {
                const userInput = chatInput.value.trim();
                if (userInput === "") return;

                displayMessage('user', userInput);
                conversationHistory.push({ role: 'user', content: userInput });
                chatInput.value = "";

                // Show thinking indicator
                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'text-left mb-2';
                thinkingDiv.id = 'thinking-indicator';
                thinkingDiv.innerHTML = `<span class="bg-gray-300 text-gray-800 p-2 rounded-lg inline-block">...</span>`;
                chatHistory.appendChild(thinkingDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                try {
                    const response = await fetch(LLM_API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${LLM_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: LLM_MODEL,
                            messages: conversationHistory
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'No error details available.' }));
                        throw new Error(`API request failed with status ${response.status}: ${errorData.error ? errorData.error.message : response.statusText}`);
                    }

                    const data = await response.json();
                    const botResponse = data.choices[0].message.content;

                    conversationHistory.push({ role: 'assistant', content: botResponse });
                    displayMessage('assistant', botResponse);

                } catch (error) {
                    console.error("Error calling LLM API:", error);
                    displayMessage('assistant', `Sorry, I encountered an error. Please check the console and your API configuration. Error: ${error.message}`);
                } finally {
                    // Remove thinking indicator
                    const indicator = document.getElementById('thinking-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            };

            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    handleSendMessage();
                }
            });
        }

        // Initialize all features when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            setupDashboard();
            setupReportingAssistant();
            setupChatbot();
        });
    </script>

</body>
</html>
